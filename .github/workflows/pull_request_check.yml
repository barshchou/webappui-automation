name: Run smoke tests and tests, included in PR

on:
  pull_request:
    types: [opened, labeled, ready_for_review]

jobs:
  Run-tsc-check:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || ( github.event.label.name == 'ready_for_review' && github.event.pull_request.draft == false && github.event_name == 'labeled' )
    container: cypress/browsers:node16.13.2-chrome100-ff98
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}

      - name: Install dependencies
        run: npm install

      - name: Run tsc:check
        run: npm run tsc:check

  Run-smoke-tests:
    needs: Run-tsc-check
    if: ${{ !github.event.pull_request.draft }} && {{ github.event.label.name == 'ready_for_review' }}
    runs-on: ubuntu-latest
    container: cypress/browsers:node16.13.2-chrome100-ff98
    permissions:
      id-token: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        containers: [ 1, 2, 3, 4, 5, 6, 7, 8 ]
    outputs:
      ENVIRONMENT: ${{ steps.define_pull_request_data.outputs.ENVIRONMENT }}
      URL: ${{ steps.define_pull_request_data.outputs.URL }}
      CUSTOM_ENV: ${{ steps.define_pull_request_data.outputs.CUSTOM_ENV }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}

      - name: Install dependencies
        run: npm install

      - name: Define env and url variables
        id: define_pull_request_data
        run: |
          ENVIRONMENT=$(node scripts/pull_request_data/index.js --token ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }} --pr ${{ github.event.number }} --data env)
          URL=$(node scripts/pull_request_data/index.js --token ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }} --pr ${{ github.event.number }} --data url)
          CUSTOM_ENV=$(node scripts/pull_request_data/index.js --token ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }} --pr ${{ github.event.number }} --data customEnv)
          echo ::set-output name=ENVIRONMENT::$ENVIRONMENT
          echo ::set-output name=URL::$URL
          echo ::set-output name=CUSTOM_ENV::$CUSTOM_ENV

      - name: Run smoke end-to-end tests with Currents dev
        uses: Bowery-RES/action-run-e2e-tests@latest
        with:
          github_token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          env: ${{ steps.define_pull_request_data.outputs.ENVIRONMENT }}
          url: ${{ steps.define_pull_request_data.outputs.URL }}
          customEnv: ${{ steps.define_pull_request_data.outputs.CUSTOM_ENV }}
          tags: grep=,grepTags=@smoke,burn=
          record_key: ${{ secrets.CURRENTS_RECORD_KEY }}
          ref: ${{ github.sha }}

  Run-included-tests:
    needs: [Run-tsc-check, Run-smoke-tests]
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }} && {{ github.event.label.name == 'ready_for_review' }}
    container: cypress/browsers:node16.13.2-chrome100-ff98
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}

      - name: Install find specs module
        run: npm install -g find-cypress-specs@1.17.0

      - name: Define included specs
        id: define_specs
        run: |
          git fetch --no-tags --depth=1 origin ${{ github.base_ref }}
          git fetch --no-tags --depth=1 origin ${{ github.head_ref }}
          git checkout origin/${{ github.base_ref }}
          git checkout origin/${{ github.head_ref }}
          git checkout ${{ github.sha }}
          CHANGED_SPECS=$(npx find-cypress-specs --branch master)
          echo ::set-output name=CHANGED_SPECS::$CHANGED_SPECS

      - name: Run included specs
        if: steps.define_specs.outputs.CHANGED_SPECS != null
        uses: Bowery-RES/action-run-e2e-tests@latest
        with:
          github_token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          env: ${{ needs.Run-smoke-tests.outputs.ENVIRONMENT }}
          url: ${{ needs.Run-smoke-tests.outputs.URL }}
          customEnv: ${{ needs.Run-smoke-tests.outputs.CUSTOM_ENV }}
          spec_file: ${{ steps.define_specs.outputs.CHANGED_SPECS }}
          record_key: ${{ secrets.CURRENTS_RECORD_KEY }}
          tags: grep=,grepTags=,burn=
          ref: ${{ github.sha }}
